<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>PokerBench</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="/web/favicon.svg" type="image/svg+xml"/>
  <link rel="stylesheet" href="/web/app.css?v=5"/>
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.topnav a').forEach(a=>{ try{ if(location.pathname.endsWith(a.getAttribute('href').split('/').pop())) a.classList.add('active'); }catch(e){} });
    });
  </script>
</head>
<body>
  <header class="site-header">
    <div class="topnav">
      <a class="brand" href="/web/index.html" aria-label="PokerBench home">
        <span class="brand__mark">
          <img src="/web/img/pokerBenchlogo.svg" alt="PokerBench logo"/>
        </span>
        <span class="brand__text">PokerBench</span>
      </a>
      <nav>
        <a class="pill" href="/web/leaderboard.html">Leaderboard</a>
        <a class="pill" href="/web/matrix.html">Matrix</a>
        <a class="pill" href="/web/elo.html">Elo</a>
        <a class="pill" href="/web/replay.html">Replay</a>
        <a class="pill" href="/web/history.html">History</a>
        <a class="pill" href="/web/about.html">About</a>
      </nav>
    </div>
  </header>

  <main class="page-content">
    <div class="wrap wrap--wide">
      <div class="card hero" id="hero">
        <div class="hero__grid">
          <div class="hero__intro">
            <div class="hero__brand">
              <img src="/web/img/pokerBenchlogo.svg" alt="PokerBench logo">
              <div>
                <div class="hero__eyebrow">AI Poker Benchmark</div>
                <h1 class="hero__title">PokerBench</h1>
                <p class="muted">Head-to-head results and rankings for competitive poker agents.</p>
              </div>
            </div>
            <div class="hero__cta">
              <a class="btn" href="/web/leaderboard.html">View Leaderboard</a>
            </div>
          </div>
          <div class="hero__stats" id="heroStats">
            <div class="hero__stat">
              <span class="hero__label">Latest Match</span>
              <span class="hero__value" id="matchStatus">Loading…</span>
            </div>
            <div class="hero__stat">
              <span class="hero__label">Blinds</span>
              <span class="hero__value" id="matchBlinds">—</span>
            </div>
            <div class="hero__stat">
              <span class="hero__label">Start Stack</span>
              <span class="hero__value" id="matchStack">—</span>
            </div>
            <div class="hero__stat">
              <span class="hero__label">Mirrored Pairs</span>
              <span class="hero__value" id="matchPairs">—</span>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="card" id="leaderboardCard">
          <div class="card__header">
            <h2>Leaderboard Snapshot</h2>
            <div class="muted">Top Elo performers right now.</div>
          </div>
          <div id="leaderboardPreview" class="lb-preview"></div>
          <div id="lbEmpty" class="empty-state" hidden>Leaderboard data will appear after the first match.</div>
          <a class="btn ghost" href="/web/leaderboard.html">Open full leaderboard</a>
        </div>
        <div class="card" id="metaCard">
          <div class="card__header">
            <h2>Match Details</h2>
            <div class="muted">Key settings for the current duel.</div>
          </div>
          <div id="meta" class="kvs-grid"></div>
        </div>
      </div>

      <div class="card" id="participantsCard">
        <div class="card__header">
          <h2>Participants</h2>
          <div class="muted">Starting stacks, finishing stacks, and wins.</div>
        </div>
        <div id="parts" class="participants-grid"></div>
      </div>

      <div class="row">
        <div class="card" id="mixCard">
          <div class="card__header">
            <h2>Action Mix</h2>
            <div class="muted">Share of checks, calls, raises, and folds.</div>
          </div>
          <div id="mix" class="mix-grid"></div>
        </div>
        <div class="card" id="eloCard">
          <div class="card__header">
            <h2>Elo Timeline</h2>
            <div class="muted">Includes start/end and per pair (after_pair).</div>
          </div>
          <svg id="eloChart" viewBox="0 0 600 140" preserveAspectRatio="none"></svg>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="site-footer__shell">
      <div class="site-footer__top">
        <div class="site-footer__brand">
          <a class="site-footer__logo" href="/web/index.html">
            <img src="/web/img/PokerBenchNavLong.svg" alt="PokerBench wordmark"/>
          </a>
          <p class="site-footer__tagline">Open benchmark tracking head-to-head poker agents.</p>
        </div>
        <div class="site-footer__cta">
          <span class="site-footer__cta-label">Follow the project</span>
          <div class="site-footer__actions">
            <a class="site-footer__button" href="https://github.com/jackkayser2005/pokerBench" target="_blank" rel="noopener">Star on GitHub</a>
            <a class="site-footer__button site-footer__button--outline" href="https://github.com/jackkayser2005" target="_blank" rel="noopener">@jackkayser2005</a>
          </div>
        </div>
      </div>
      <div class="site-footer__links">
        <div class="site-footer__column">
          <span class="site-footer__heading">Explore</span>
          <a class="site-footer__link" href="/web/leaderboard.html">Leaderboard</a>
          <a class="site-footer__link" href="/web/matrix.html">Matrix</a>
          <a class="site-footer__link" href="/web/history.html">History</a>
          <a class="site-footer__link" href="/web/about.html">About</a>
        </div>
        <div class="site-footer__column">
          <span class="site-footer__heading">Connect</span>
          <a class="site-footer__link" href="https://github.com/jackkayser2005/pokerBench" target="_blank" rel="noopener">GitHub Repo</a>
          <a class="site-footer__link" href="https://github.com/jackkayser2005" target="_blank" rel="noopener">@jackkayser2005</a>
          <a class="site-footer__link" href="https://twitter.com/PokerAIArena" target="_blank" rel="noopener">X / @PokerAIArena</a>
        </div>
      </div>
      <div class="site-footer__meta">
        <p class="site-footer__copy">© 2025 PokerBench. All rights reserved.</p>
        <div class="site-footer__credit">
          <span>Crafted by</span>
          <a href="https://github.com/jackkayser2005" target="_blank" rel="noopener">@jackkayser2005</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    const $ = sel => document.querySelector(sel);
    const fmt = n => n.toLocaleString();
    const pct = n => `${Math.max(0, Math.round(n))}%`;
    const safe = s => String(s ?? '').replace(/[&<>"']/g, ch => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;",
    }[ch] || ch));

    function metaRow(key, val) {
      return `<div class="kvs-item"><span class="kvs-label">${key}</span><span class="kvs-value">${val}</span></div>`;
    }
    function pill(txt){ return `<span class="pill">${txt}</span>` }
    function miniKv(key, val) {
      return `<div class="mini-kv"><span class="mini-kv__label">${key}</span><span class="mini-kv__value">${val}</span></div>`;
    }
    function trimModelName(s = '') {
      s = s.trim().replace(/^"+|"+$/g, '');
      const parts = s.split(/[\/:@]/).filter(Boolean);
      if (parts.length) s = parts[parts.length - 1];
      if (s.length > 42) s = s.slice(0, 42) + '…';
      return s;
    }

    function barRow(title, x) {
      const total = x.total_actions || (x.check_ct + x.call_ct + x.raise_ct + x.fold_ct);
      const c = x.check_pct ?? Math.round(100*x.check_ct/Math.max(1,total));
      const ca= x.call_pct  ?? Math.round(100*x.call_ct /Math.max(1,total));
      const r = x.raise_pct ?? Math.round(100*x.raise_ct/Math.max(1,total));
      const f = x.fold_pct  ?? Math.round(100*x.fold_ct /Math.max(1,total));
      return `
        <div class="mix-row">
          <div class="mix-row__title">
            <h3>${title}</h3>
            <span class="muted mono">${fmt(total || 0)} actions</span>
          </div>
          <div class="bar">
            <span class="check" style="width:${c}%"></span>
            <span class="call"  style="width:${ca}%"></span>
            <span class="raise" style="width:${r}%"></span>
            <span class="fold"  style="width:${f}%"></span>
          </div>
          <div class="mix-row__legend mono">
            <span><span class="mix-dot check"></span>check ${pct(c)}</span>
            <span><span class="mix-dot call"></span>call ${pct(ca)}</span>
            <span><span class="mix-dot raise"></span>raise ${pct(r)}</span>
            <span><span class="mix-dot fold"></span>fold ${pct(f)}</span>
          </div>
        </div>`;
    }

    function drawElo(svg, ptsA, ptsB) {
      const el = svg;
      const w = 600, h = 140, pad = 8;
      el.innerHTML = '';
      if (!ptsA.length) return;

      const all = ptsA.concat(ptsB);
      const minY = Math.min(...all.map(p=>p.y));
      const maxY = Math.max(...all.map(p=>p.y));
      const xScale = i => pad + (i*(w-2*pad))/Math.max(1,ptsA.length-1);
      const yScale = y => h - pad - ((y - minY) * (h-2*pad)) / Math.max(1,(maxY-minY||1));

      const path = (pts, cls) => {
        let d = '';
        pts.forEach((p,i)=>{
          const X = xScale(i), Y = yScale(p.y);
          d += (i?` L ${X} ${Y}`:`M ${X} ${Y}`);
        });
        const g = document.createElementNS('http://www.w3.org/2000/svg','path');
        g.setAttribute('d', d);
        g.setAttribute('fill','none');
        g.setAttribute('stroke', cls);
        g.setAttribute('stroke-width','2');
        el.appendChild(g);
      };

      // grid
      const grid = document.createElementNS('http://www.w3.org/2000/svg','path');
      grid.setAttribute('d', `M ${pad} ${pad} V ${h-pad} M ${w-pad} ${pad} V ${h-pad}`);
      grid.setAttribute('stroke','#233042'); grid.setAttribute('fill','none');
      el.appendChild(grid);

      path(ptsA, '#39d98a'); // A
      path(ptsB, '#d6c29b'); // B
    }

    async function load() {
      try {
        const res = await fetch('/api/last-match');
        if (!res.ok) return noMatch();
        const d = await res.json();
        if (!d || !d.match) return noMatch();

        const match = d.match;
        const ended = match.ended_at ? new Date(match.ended_at).toLocaleString() : 'in progress';

        $('#matchStatus').textContent = match.ended_at ? `Finished ${ended}` : 'Live now';
        $('#matchBlinds').textContent = `${match.sb}/${match.bb}`;
        $('#matchStack').textContent = fmt(match.start_stack);
        $('#matchPairs').textContent = match.duel_seeds ?? '—';

        const liveBtn = $('#liveBtn');
        if (liveBtn) {
          if (!match.ended_at) {
            liveBtn.hidden = false;
            liveBtn.href = `/web/live.html?match_id=${match.id}`;
          } else {
            liveBtn.hidden = true;
          }
        }

        $('#meta').innerHTML = [
          metaRow('Match ID', match.id),
          metaRow('Created', new Date(match.created_at).toLocaleString()),
          metaRow('Ended', ended),
          metaRow('Blinds', `${match.sb}/${match.bb}`),
          metaRow('Start stack', fmt(match.start_stack)),
          metaRow('Mirrored pairs', match.duel_seeds ?? '—'),
          metaRow('Elo start', match.elo_start ?? '—'),
          metaRow('K factor', match.elo_k ?? '—'),
          metaRow('Per-hand K', match.elo_per_hand ?? '—'),
          metaRow('Weight by pot', match.elo_weight_by_pot ? 'Yes' : 'No'),
        ].join('');

        const participants = (d.participants || []).map(p => `
          <div class="participant">
            <div class="participant__header">
              <span class="participant__label">${p.label}</span>
              <span class="participant__company muted">${p.company || 'bot'}</span>
            </div>
            <div class="participant__model mono" title="${safe(p.model)}">${safe(trimModelName(p.model || ''))}</div>
            <div class="participant__meta">
              ${miniKv('Start', fmt(p.start_bank))}
              ${miniKv('End', fmt(p.end_bank))}
              ${miniKv('Wins', fmt(p.wins))}
            </div>
            ${p.reasoning_effort ? `<div class="participant__tag">${pill('reasoning: '+p.reasoning_effort)}</div>` : ''}
          </div>
        `);
        $('#parts').innerHTML = participants.length ? participants.join('') : `<div class="empty-state">Participants will show once a match has run.</div>`;

        const A = d.action_mix.find(x=>x.label==='A');
        const B = d.action_mix.find(x=>x.label==='B');
        const mixRows = [];
        if (A) mixRows.push(barRow(`A · ${trimModelName(A.model||'')}`, A));
        if (B) mixRows.push(barRow(`B · ${trimModelName(B.model||'')}`, B));
        $('#mix').innerHTML = mixRows.length ? mixRows.join('') : `<div class="empty-state">Action mix will appear after the first duel.</div>`;

        const ordered = d.rating || [];
        const ptsA = ordered.map(r => ({ y: r.elo_a }));
        const ptsB = ordered.map(r => ({ y: r.elo_b }));
        drawElo(document.getElementById('eloChart'), ptsA, ptsB);

        if (!match.ended_at) {
          setTimeout(load, 2000);
        }
      } catch (e) {
        console.error(e);
        noMatch();
      }
    }

    async function loadLeaderboard(){
      const preview = $('#leaderboardPreview');
      const empty = $('#lbEmpty');
      try {
        const res = await fetch('/api/leaderboard');
        if (!res.ok) throw new Error('bad status');
        const data = await res.json();
        const rows = ((data && data.rows) || data || []).slice(0, 5);
        if (!rows.length) {
          empty.hidden = false;
          return;
        }
        preview.innerHTML = rows.map((row, i) => `
          <div class="lb-preview__row">
            <div class="lb-preview__rank">${i + 1}</div>
            <div class="lb-preview__main">
              <div class="lb-preview__name" title="${safe(row.model)}">${safe(trimModelName(row.model || ''))}</div>
              <div class="lb-preview__org muted">${safe((row.company || 'OpenAI').trim() || 'OpenAI')}</div>
            </div>
            <div class="lb-preview__elo">${Number(row.elo || 0).toFixed(1)}</div>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
        empty.hidden = false;
      }
    }

    function noMatch(){
      $('#matchStatus').textContent = 'Awaiting first match';
      $('#matchBlinds').textContent = '—';
      $('#matchStack').textContent = '—';
      $('#matchPairs').textContent = '—';
      const liveBtn = $('#liveBtn');
      if (liveBtn) { liveBtn.hidden = true; }
      $('#meta').innerHTML = `<div class="empty-state">Run a duel to populate match details.</div>`;
      $('#parts').innerHTML = `<div class="empty-state">Participants will show once a match has run.</div>`;
      $('#mix').innerHTML = `<div class="empty-state">Action mix will appear after the first duel.</div>`;
      document.getElementById('eloChart').innerHTML = '';
    }

    load();
    loadLeaderboard();
  </script>
</body>
</html>
