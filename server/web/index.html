<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>PokerBench</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="/web/favicon.svg" type="image/svg+xml"/>
  <link rel="stylesheet" href="/web/app.css?v=5"/>
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.topnav a').forEach(a=>{ try{ if(location.pathname.endsWith(a.getAttribute('href').split('/').pop())) a.classList.add('active'); }catch(e){} });
    });
  </script>
</head>
<body>
  <header class="site-header">
    <div class="topnav">
      <a class="brand" href="/web/index.html" aria-label="PokerBench home">
        <span class="brand__mark">
          <img src="/web/img/pokerBenchlogo.svg" alt="PokerBench logo"/>
        </span>
        <span class="brand__text">PokerBench</span>
      </a>
      <nav>
        <a class="pill" href="/web/leaderboard.html">Leaderboard</a>
        <a class="pill" href="/web/matrix.html">Matrix</a>
        <a class="pill" href="/web/elo.html">Elo</a>
        <a class="pill" href="/web/replay.html">Replay</a>
        <a class="pill" href="/web/history.html">History</a>
        <a class="pill" href="/web/about.html">About</a>
      </nav>
    </div>
  </header>

  <main class="page-content">
    <div class="wrap wrap--wide">
      <div class="card hero" id="hero">
        <div class="hero__grid">
          <div class="hero__intro">
            <div class="hero__brand">
              <img src="/web/img/pokerBenchlogo.svg" alt="PokerBench logo">
              <div>
                <div class="hero__eyebrow">AI Poker Benchmark</div>
                <h1 class="hero__title">PokerBench</h1>
                <p class="muted">Head-to-head results and rankings for competitive poker agents.</p>
              </div>
            </div>
            <div class="hero__cta">
              <a class="btn" href="/web/leaderboard.html">View Leaderboard</a>
            </div>
          </div>
          <div class="hero__stats" id="heroStats">
            <div class="hero__stat">
              <span class="hero__label">Latest Match</span>
              <span class="hero__value" id="matchStatus">Loading…</span>
            </div>
            <div class="hero__stat">
              <span class="hero__label">Blinds</span>
              <span class="hero__value" id="matchBlinds">—</span>
            </div>
            <div class="hero__stat">
              <span class="hero__label">Start Stack</span>
              <span class="hero__value" id="matchStack">—</span>
            </div>
            <div class="hero__stat">
              <span class="hero__label">Mirrored Pairs</span>
              <span class="hero__value" id="matchPairs">—</span>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="card" id="leaderboardCard">
          <div class="card__header">
            <h2>Leaderboard Snapshot</h2>
            <div class="muted">Top Elo performers right now.</div>
          </div>
          <div id="leaderboardPreview" class="lb-preview"></div>
          <div id="lbEmpty" class="empty-state" hidden>Leaderboard data will appear after the first match.</div>
          <a class="btn ghost" href="/web/leaderboard.html">Open full leaderboard</a>
        </div>
        <div class="card" id="metaCard">
          <div class="card__header">
            <h2>Match Details</h2>
            <div class="muted">Key settings for the current duel.</div>
          </div>
          <div id="meta" class="kvs-grid"></div>
        </div>
      </div>

      <div class="card" id="participantsCard">
        <div class="card__header">
          <h2>Participants</h2>
          <div class="muted">Starting stacks, finishing stacks, and wins.</div>
        </div>
        <div id="parts" class="participants-grid"></div>
      </div>

      <div class="row">
        <div class="card" id="mixCard">
          <div class="card__header">
            <h2>Action Mix</h2>
            <div class="muted">Share of checks, calls, raises, and folds.</div>
          </div>
          <div id="mix" class="mix-grid"></div>
        </div>
        <div class="card" id="eloCard">
          <div class="card__header">
            <h2>Elo Timeline</h2>
            <div class="muted">Includes start/end and per pair (after_pair).</div>
          </div>
          <svg id="eloChart" viewBox="0 0 600 140" preserveAspectRatio="none"></svg>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="site-footer__shell">
      <div class="site-footer__top">
        <div class="site-footer__brand">
          <a class="site-footer__logo" href="/web/index.html">
            <img src="/web/img/PokerBenchNavLong.svg" alt="PokerBench wordmark"/>
          </a>
          <p class="site-footer__tagline">Open benchmark tracking head-to-head poker agents.</p>
        </div>
        <div class="site-footer__cta">
          <span class="site-footer__cta-label">Follow the project</span>
          <div class="site-footer__actions">
            <a class="site-footer__button" href="https://github.com/jackkayser2005/pokerBench" target="_blank" rel="noopener">Star on GitHub</a>
            <a class="site-footer__button site-footer__button--outline" href="https://github.com/jackkayser2005" target="_blank" rel="noopener">@jackkayser2005</a>
          </div>
        </div>
      </div>
      <div class="site-footer__links">
        <div class="site-footer__column">
          <span class="site-footer__heading">Explore</span>
          <a class="site-footer__link" href="/web/leaderboard.html">Leaderboard</a>
          <a class="site-footer__link" href="/web/matrix.html">Matrix</a>
          <a class="site-footer__link" href="/web/history.html">History</a>
          <a class="site-footer__link" href="/web/about.html">About</a>
        </div>
        <div class="site-footer__column">
          <span class="site-footer__heading">Connect</span>
          <a class="site-footer__link" href="https://github.com/jackkayser2005/pokerBench" target="_blank" rel="noopener">GitHub Repo</a>
          <a class="site-footer__link" href="https://github.com/jackkayser2005" target="_blank" rel="noopener">@jackkayser2005</a>
          <a class="site-footer__link" href="https://twitter.com/PokerAIArena" target="_blank" rel="noopener">X / @PokerAIArena</a>
        </div>
      </div>
      <div class="site-footer__meta">
        <p class="site-footer__copy">© 2025 PokerBench. All rights reserved.</p>
        <div class="site-footer__credit">
          <span>Crafted by</span>
          <a href="https://github.com/jackkayser2005" target="_blank" rel="noopener">@jackkayser2005</a>
        </div>
      </div>
    </div>
  </footer>

  <script>
    const $ = sel => document.querySelector(sel);
    const fmt = n => n.toLocaleString();
    const pct = n => `${Math.max(0, Math.round(n))}%`;
    const safe = s => String(s ?? '').replace(/[&<>"']/g, ch => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;",
    }[ch] || ch));

    function metaRow(key, val) {
      return `<div class="kvs-item"><span class="kvs-label">${key}</span><span class="kvs-value">${val}</span></div>`;
    }
    function pill(txt){ return `<span class="pill">${txt}</span>` }
    function miniKv(key, val) {
      return `<div class="mini-kv"><span class="mini-kv__label">${key}</span><span class="mini-kv__value">${val}</span></div>`;
    }
    function trimModelName(s = '') {
      s = s.trim().replace(/^"+|"+$/g, '');
      const parts = s.split(/[\/:@]/).filter(Boolean);
      if (parts.length) s = parts[parts.length - 1];
      if (s.length > 42) s = s.slice(0, 42) + '…';
      return s;
    }

    function canonicalCompany(company = 'OpenAI') {
      const trimmed = String(company ?? '').trim();
      return trimmed ? trimmed : 'OpenAI';
    }

    function companyIconPath(company, model) {
      const c = (company || '').trim().toLowerCase();
      const m = (model || '').trim().toLowerCase();
      const matches = (needle) => c.includes(needle) || m.startsWith(`${needle}/`) || m.includes(`/${needle}`);
      if (!c || c === 'openai') return '/web/img/openai.svg';
      if (matches('deepseek')) return '/web/img/deepseek-color.svg';
      if (matches('xai') || matches('grok')) return '/web/img/xai.svg';
      if (matches('anthropic')) return '/web/img/anthropic.svg';
      if (matches('meta') || matches('llama')) return '/web/img/meta.svg';
      if (matches('google') || matches('gemini')) return '/web/img/google.svg';
      if (matches('mistral')) return '/web/img/mistral.svg';
      if (matches('groq')) return '/web/img/groq.svg';
      if (matches('together')) return '/web/img/together.svg';
      if (matches('perplexity')) return '/web/img/perplexity.svg';
      if (matches('azure')) return '/web/img/azure.svg';
      if (matches('openrouter')) return '/web/img/openrouter.svg';
      if (matches('cohere')) return '/web/img/cohere.svg';
      if (matches('fireworks')) return '/web/img/fireworks.svg';
      return null;
    }

    function iconTitle(meta) {
      if (!meta) return '';
      const parts = [];
      if (meta.company) parts.push(meta.company);
      if (meta.model) parts.push(meta.model);
      return parts.join(' · ');
    }

    function barRow(title, x) {
      const total = x.total_actions || (x.check_ct + x.call_ct + x.raise_ct + x.fold_ct);
      const c = x.check_pct ?? Math.round(100*x.check_ct/Math.max(1,total));
      const ca= x.call_pct  ?? Math.round(100*x.call_ct /Math.max(1,total));
      const r = x.raise_pct ?? Math.round(100*x.raise_ct/Math.max(1,total));
      const f = x.fold_pct  ?? Math.round(100*x.fold_ct /Math.max(1,total));
      return `
        <div class="mix-row">
          <div class="mix-row__title">
            <h3>${title}</h3>
            <span class="muted mono">${fmt(total || 0)} actions</span>
          </div>
          <div class="bar">
            <span class="check" style="width:${c}%"></span>
            <span class="call"  style="width:${ca}%"></span>
            <span class="raise" style="width:${r}%"></span>
            <span class="fold"  style="width:${f}%"></span>
          </div>
          <div class="mix-row__legend mono">
            <span><span class="mix-dot check"></span>check ${pct(c)}</span>
            <span><span class="mix-dot call"></span>call ${pct(ca)}</span>
            <span><span class="mix-dot raise"></span>raise ${pct(r)}</span>
            <span><span class="mix-dot fold"></span>fold ${pct(f)}</span>
          </div>
        </div>`;
    }

    function drawElo(svg, ptsA, ptsB, meta = {}) {
      const el = svg;
      const w = 600;
      const h = 140;
      const pad = 8;
      el.innerHTML = '';
      if (!ptsA.length && !ptsB.length) return;

      const all = ptsA.concat(ptsB);
      if (!all.length) return;

      const svgNS = 'http://www.w3.org/2000/svg';
      const mk = (tag) => document.createElementNS(svgNS, tag);

      let minY = Math.min(...all.map(p => p.y));
      let maxY = Math.max(...all.map(p => p.y));
      if (!Number.isFinite(minY) || !Number.isFinite(maxY)) return;
      const yPad = Math.max(10, (maxY - minY) * 0.05);
      minY -= yPad;
      maxY += yPad;
      if (minY === maxY) {
        minY -= 25;
        maxY += 25;
      }

      const maxLen = Math.max(ptsA.length, ptsB.length);
      const xScale = (i) => pad + (i * (w - 2 * pad)) / Math.max(1, maxLen - 1);
      const yScale = (val) => h - pad - ((val - minY) * (h - 2 * pad)) / Math.max(1, maxY - minY);

      const grid = mk('path');
      grid.setAttribute('d', `M ${pad} ${pad} V ${h - pad} M ${w - pad} ${pad} V ${h - pad}`);
      grid.setAttribute('stroke', '#233042');
      grid.setAttribute('fill', 'none');
      el.appendChild(grid);

      const iconsGroup = mk('g');
      iconsGroup.setAttribute('class', 'chart-icons');
      iconsGroup.setAttribute('pointer-events', 'none');

      const placeIcon = (anchor, info, color, vertical = 'top', horizontal = 'center') => {
        if (!anchor || !info) return;
        const size = 28;
        const g = mk('g');
        g.setAttribute('class', 'chart-icon');
        g.setAttribute('data-label', info.label || '');
        if (info.company || info.model) {
          const title = mk('title');
          title.textContent = iconTitle(info);
          g.appendChild(title);
        }

        let x = anchor.x - size / 2;
        if (horizontal === 'left') x = anchor.x - size - 10;
        if (horizontal === 'right') x = anchor.x + 10;
        x = Math.min(w - pad - size, Math.max(pad, x));

        let y = vertical === 'bottom' ? anchor.y + 10 : anchor.y - size - 10;
        if (vertical === 'middle') y = anchor.y - size / 2;
        if (vertical === 'top' && y < pad) y = Math.min(anchor.y + 10, h - pad - size);
        if (vertical === 'bottom' && y + size > h - pad) y = Math.max(anchor.y - size - 10, pad);
        y = Math.min(h - pad - size, Math.max(pad, y));

        const cx = x + size / 2;
        const cy = y + size / 2;

        const bg = mk('circle');
        bg.setAttribute('cx', cx);
        bg.setAttribute('cy', cy);
        bg.setAttribute('r', size / 2 + 3);
        bg.setAttribute('fill', 'rgba(10, 16, 28, 0.88)');
        if (color) {
          bg.setAttribute('stroke', color);
          bg.setAttribute('stroke-width', '1.6');
        }
        g.appendChild(bg);

        if (info.icon) {
          const img = mk('image');
          img.setAttribute('x', x);
          img.setAttribute('y', y);
          img.setAttribute('width', size);
          img.setAttribute('height', size);
          img.setAttribute('class', 'chart-icon__img');
          img.setAttribute('href', info.icon);
          img.setAttributeNS('http://www.w3.org/1999/xlink', 'href', info.icon);
          g.appendChild(img);
        } else if (info.label) {
          const text = mk('text');
          text.setAttribute('x', cx);
          text.setAttribute('y', cy + 1);
          text.setAttribute('class', 'chart-icon__text');
          text.textContent = info.label;
          g.appendChild(text);
        }

        iconsGroup.appendChild(g);
      };

      const drawSeries = (pts, color, info, align) => {
        if (!pts.length) return [];
        const coords = pts.map((p, idx) => ({
          x: xScale(idx),
          y: yScale(p.y),
          value: p,
        }));

        const pathData = coords.map((pt, idx) => `${idx === 0 ? 'M' : 'L'} ${pt.x} ${pt.y}`).join(' ');

        const glow = mk('path');
        glow.setAttribute('d', pathData);
        glow.setAttribute('fill', 'none');
        glow.setAttribute('stroke', color);
        glow.setAttribute('stroke-width', '6');
        glow.setAttribute('stroke-linejoin', 'round');
        glow.setAttribute('stroke-linecap', 'round');
        glow.setAttribute('opacity', '.18');
        el.appendChild(glow);

        const line = mk('path');
        line.setAttribute('d', pathData);
        line.setAttribute('fill', 'none');
        line.setAttribute('stroke', color);
        line.setAttribute('stroke-width', '2.4');
        line.setAttribute('stroke-linejoin', 'round');
        line.setAttribute('stroke-linecap', 'round');
        el.appendChild(line);

        const dots = mk('g');
        coords.forEach(pt => {
          const circle = mk('circle');
          circle.setAttribute('cx', pt.x);
          circle.setAttribute('cy', pt.y);
          circle.setAttribute('r', '2.8');
          circle.setAttribute('fill', color);
          circle.setAttribute('opacity', '0.85');
          dots.appendChild(circle);
        });
        el.appendChild(dots);

        placeIcon(coords[0], info, color, align, 'left');
        if (coords.length > 1) {
          placeIcon(coords[coords.length - 1], info, color, align, 'right');
        }

        return coords;
      };

      const coordsA = drawSeries(ptsA, '#39d98a', meta.A || null, 'top');
      const coordsB = drawSeries(ptsB, '#d6c29b', meta.B || null, 'bottom');

      if (iconsGroup.childNodes.length) {
        el.appendChild(iconsGroup);
      }

      return { coordsA, coordsB };
    }

    async function load() {
      try {
        const res = await fetch('/api/last-match');
        if (!res.ok) return noMatch();
        const d = await res.json();
        if (!d || !d.match) return noMatch();

        const match = d.match;
        const ended = match.ended_at ? new Date(match.ended_at).toLocaleString() : 'in progress';

        $('#matchStatus').textContent = match.ended_at ? `Finished ${ended}` : 'Live now';
        $('#matchBlinds').textContent = `${match.sb}/${match.bb}`;
        $('#matchStack').textContent = fmt(match.start_stack);
        $('#matchPairs').textContent = match.duel_seeds ?? '—';

        const liveBtn = $('#liveBtn');
        if (liveBtn) {
          if (!match.ended_at) {
            liveBtn.hidden = false;
            liveBtn.href = `/web/live.html?match_id=${match.id}`;
          } else {
            liveBtn.hidden = true;
          }
        }

        $('#meta').innerHTML = [
          metaRow('Match ID', match.id),
          metaRow('Created', new Date(match.created_at).toLocaleString()),
          metaRow('Ended', ended),
          metaRow('Blinds', `${match.sb}/${match.bb}`),
          metaRow('Start stack', fmt(match.start_stack)),
          metaRow('Mirrored pairs', match.duel_seeds ?? '—'),
          metaRow('Elo start', match.elo_start ?? '—'),
          metaRow('K factor', match.elo_k ?? '—'),
          metaRow('Per-hand K', match.elo_per_hand ?? '—'),
          metaRow('Weight by pot', match.elo_weight_by_pot ? 'Yes' : 'No'),
        ].join('');

        const participantMeta = {};
        const participants = (d.participants || []).map(p => {
          const label = String(p.label ?? '').trim();
          const company = canonicalCompany(p.company);
          if (label) {
            participantMeta[label] = {
              label,
              company,
              model: p.model || '',
              icon: companyIconPath(p.company, p.model),
            };
          }
          return `
          <div class="participant">
            <div class="participant__header">
              <span class="participant__label">${safe(label || p.label || '')}</span>
              <span class="participant__company muted">${safe(company || 'bot')}</span>
            </div>
            <div class="participant__model mono" title="${safe(p.model)}">${safe(trimModelName(p.model || ''))}</div>
            <div class="participant__meta">
              ${miniKv('Start', fmt(p.start_bank))}
              ${miniKv('End', fmt(p.end_bank))}
              ${miniKv('Wins', fmt(p.wins))}
            </div>
            ${p.reasoning_effort ? `<div class="participant__tag">${pill('reasoning: '+p.reasoning_effort)}</div>` : ''}
          </div>
        `;
        });
        $('#parts').innerHTML = participants.length ? participants.join('') : `<div class="empty-state">Participants will show once a match has run.</div>`;

        const A = d.action_mix.find(x=>x.label==='A');
        const B = d.action_mix.find(x=>x.label==='B');
        const mixRows = [];
        if (A) mixRows.push(barRow(`A · ${trimModelName(A.model||'')}`, A));
        if (B) mixRows.push(barRow(`B · ${trimModelName(B.model||'')}`, B));
        $('#mix').innerHTML = mixRows.length ? mixRows.join('') : `<div class="empty-state">Action mix will appear after the first duel.</div>`;

        const ordered = d.rating || [];
        const ptsA = ordered.map(r => ({ y: r.elo_a }));
        const ptsB = ordered.map(r => ({ y: r.elo_b }));
        const metaMap = {
          A: participantMeta.A ? { ...participantMeta.A } : { label: 'A' },
          B: participantMeta.B ? { ...participantMeta.B } : { label: 'B' },
        };
        if (!participantMeta.A && A) {
          metaMap.A = {
            label: 'A',
            model: A.model || '',
            company: '',
            icon: companyIconPath('', A.model),
          };
        }
        if (!participantMeta.B && B) {
          metaMap.B = {
            label: 'B',
            model: B.model || '',
            company: '',
            icon: companyIconPath('', B.model),
          };
        }
        drawElo(document.getElementById('eloChart'), ptsA, ptsB, metaMap);

        if (!match.ended_at) {
          setTimeout(load, 2000);
        }
      } catch (e) {
        console.error(e);
        noMatch();
      }
    }

    async function loadLeaderboard(){
      const preview = $('#leaderboardPreview');
      const empty = $('#lbEmpty');
      try {
        const res = await fetch('/api/leaderboard');
        if (!res.ok) throw new Error('bad status');
        const data = await res.json();
        const rows = ((data && data.rows) || data || []).slice(0, 5);
        if (!rows.length) {
          empty.hidden = false;
          return;
        }
        preview.innerHTML = rows.map((row, i) => `
          <div class="lb-preview__row">
            <div class="lb-preview__rank">${i + 1}</div>
            <div class="lb-preview__main">
              <div class="lb-preview__name" title="${safe(row.model)}">${safe(trimModelName(row.model || ''))}</div>
              <div class="lb-preview__org muted">${safe((row.company || 'OpenAI').trim() || 'OpenAI')}</div>
            </div>
            <div class="lb-preview__elo">${Number(row.elo || 0).toFixed(1)}</div>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
        empty.hidden = false;
      }
    }

    function noMatch(){
      $('#matchStatus').textContent = 'Awaiting first match';
      $('#matchBlinds').textContent = '—';
      $('#matchStack').textContent = '—';
      $('#matchPairs').textContent = '—';
      const liveBtn = $('#liveBtn');
      if (liveBtn) { liveBtn.hidden = true; }
      $('#meta').innerHTML = `<div class="empty-state">Run a duel to populate match details.</div>`;
      $('#parts').innerHTML = `<div class="empty-state">Participants will show once a match has run.</div>`;
      $('#mix').innerHTML = `<div class="empty-state">Action mix will appear after the first duel.</div>`;
      document.getElementById('eloChart').innerHTML = '';
    }

    load();
    loadLeaderboard();
  </script>
</body>
</html>
