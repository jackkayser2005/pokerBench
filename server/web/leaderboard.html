<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>AI Poker Lab - Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/web/app.css?v=5"/>
  <link rel="icon" href="/web/favicon.svg" type="image/svg+xml"/>
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('.topnav a').forEach(a=>{
        try{
          const last = a.getAttribute('href').split('/').pop();
          if (location.pathname.endsWith(last)) a.classList.add('active');
        }catch(e){}
      });
    });

    const $   = s => document.querySelector(s);
    const fmt = n => Number(n||0).toLocaleString();
    const escapeHtml = (s = '') => s.replace(/[&<>"']/g, ch => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[ch]));

    const COMPANY_ICON_DATA = {
      openai:      { path: '/web/img/openai.svg', alt: 'OpenAI' },
      deepseek:    { path: '/web/img/deepseek-color.svg', alt: 'DeepSeek' },
      xai:         { path: '/web/img/xai.svg', alt: 'xAI' },
      anthropic:   { path: '/web/img/anthropic.svg', alt: 'Anthropic' },
      meta:        { path: '/web/img/meta.svg', alt: 'Meta' },
      google:      { path: '/web/img/google.svg', alt: 'Google' },
      mistral:     { path: '/web/img/mistral.svg', alt: 'Mistral' },
      groq:        { path: '/web/img/groq.svg', alt: 'Groq' },
      together:    { path: '/web/img/together.svg', alt: 'Together' },
      perplexity:  { path: '/web/img/perplexity.svg', alt: 'Perplexity' },
      azure:       { path: '/web/img/azure.svg', alt: 'Azure' },
      openrouter:  { path: '/web/img/openrouter.svg', alt: 'OpenRouter' },
      cohere:      { path: '/web/img/cohere.svg', alt: 'Cohere' },
      fireworks:   { path: '/web/img/fireworks.svg', alt: 'Fireworks' },
      qwen:        { path: '/web/img/qwen.svg', alt: 'Qwen' },
    };

    const COMPANY_ALIAS = {
      llama: 'meta',
      llamaii: 'meta',
      grok: 'xai',
      'xai': 'xai',
      'x.ai': 'xai',
      gemini: 'google',
      mistralai: 'mistral',
      metallama: 'meta',
      googledeepmind: 'google',
      perplexityai: 'perplexity',
      togetherai: 'together',
      togethercomputer: 'together',
      fireworksai: 'fireworks',
      claude: 'anthropic',
      claude35: 'anthropic',
    };

    const COMPANY_LABELS = {
      openai: 'OpenAI',
      deepseek: 'DeepSeek',
      xai: 'xAI',
      anthropic: 'Anthropic',
      meta: 'Meta',
      google: 'Google',
      mistral: 'Mistral',
      groq: 'Groq',
      together: 'Together',
      perplexity: 'Perplexity',
      azure: 'Azure',
      openrouter: 'OpenRouter',
      cohere: 'Cohere',
      fireworks: 'Fireworks',
      qwen: 'Qwen',
    };

    function slugifyCompany(value) {
      return String(value || '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '');
    }

    function prettyCompanyName(value) {
      const slug = slugifyCompany(value);
      if (COMPANY_LABELS[slug]) return COMPANY_LABELS[slug];
      if (!value) return '';
      return String(value)
        .replace(/[_-]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim()
        .replace(/\b\w/g, ch => ch.toUpperCase());
    }

    function extractOpenRouterVendor(model) {
      if (!model) return '';
      const match = String(model).match(/openrouter[\\/:|-]+([A-Za-z0-9_.-]+)/i);
      if (match && match[1]) return match[1];
      const parts = String(model)
        .split(/[\\/:]/)
        .map(part => part.trim())
        .filter(Boolean);
      if (!parts.length) return '';
      const idx = parts.findIndex(part => part.toLowerCase() === 'openrouter');
      if (idx >= 0) {
        if (parts[idx + 1]) return parts[idx + 1];
        if (idx > 0) return parts[idx - 1];
      }
      return '';
    }

    function normalizeCompanySlug(value) {
      const slug = slugifyCompany(value);
      if (!slug || slug === 'openrouter') return '';
      if (COMPANY_ALIAS[slug]) return COMPANY_ALIAS[slug];
      const prefixMap = [
        ['openai', 'openai'],
        ['gpt', 'openai'],
        ['chatgpt', 'openai'],
        ['claude', 'anthropic'],
        ['anthropic', 'anthropic'],
        ['meta', 'meta'],
        ['llama', 'meta'],
        ['metallama', 'meta'],
        ['mistral', 'mistral'],
        ['mistralai', 'mistral'],
        ['google', 'google'],
        ['deepmind', 'google'],
        ['gemini', 'google'],
        ['gemma', 'google'],
        ['perplexity', 'perplexity'],
        ['together', 'together'],
        ['cohere', 'cohere'],
        ['fireworks', 'fireworks'],
        ['qwen', 'qwen'],
        ['deepseek', 'deepseek'],
        ['groq', 'groq'],
        ['azure', 'azure'],
        ['xai', 'xai'],
        ['grok', 'xai'],
      ];
      for (const [prefix, target] of prefixMap) {
        if (slug.startsWith(prefix)) return target;
      }
      return slug;
    }

    function resolveCompanyMeta(company, model) {
      const rawCompany = String(company || '').trim();
      const modelStr = String(model || '').trim();
      const lowerModel = modelStr.toLowerCase();
      const vendor = lowerModel.includes('openrouter') ? extractOpenRouterVendor(modelStr) : '';

      const candidateStrings = [rawCompany, vendor];
      if (modelStr) {
        modelStr.split(/[^A-Za-z0-9]+/).forEach(part => {
          if (part) candidateStrings.push(part);
        });
      }
      if (vendor) {
        vendor.split(/[^A-Za-z0-9]+/).forEach(part => {
          if (part) candidateStrings.push(part);
        });
      }
      if (lowerModel.includes('openrouter')) {
        modelStr.split(/[\/:@-]/).forEach(part => {
          if (part) candidateStrings.push(part);
        });
      }

      const candidateSlugs = candidateStrings
        .map(normalizeCompanySlug)
        .filter(Boolean);

      let slug = candidateSlugs.find(s => COMPANY_ICON_DATA[s]) || candidateSlugs[0] || '';
      if (!slug) slug = 'openai';

      const labelSource = vendor || rawCompany || slug;
      const label = COMPANY_LABELS[slug] || prettyCompanyName(labelSource) || 'OpenAI';
      return { slug, label };
    }

    const canonicalCompany = (company, model) => resolveCompanyMeta(company, model).label;
    const dateFmt = (iso) => {
      const d = new Date(iso);
      return d.toLocaleString([], { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    };
    const trim1 = s => (s||'').trim();

    function trimModelName(s) {
      s = (s || '').trim().replace(/^"+|"+$/g, '');
      s = s.replace(/[\-_.]20\d{2}(?:[\-_.]?\d{2}){0,2}$/,'');
      const parts = s.split(/[\/:@]/).filter(Boolean);
      s = (parts[parts.length - 1] || s).trim();
      s = s.replace(/\s*\((?:[^)]*20\d{2}[^)]*)\)\s*$/,'').trim();
      if (s.length > 36) s = s.slice(0,36) + '...';
      return s;
    }

    function wilson(pWins, nHands){
      const z = 1.96;
      if (!nHands || nHands <= 0) return [0,0];
      const n = nHands;
      const p = Math.max(0, Math.min(1, (pWins + 0.0) / n));
      const den = 1 + (z*z)/n;
      const center = p + (z*z)/(2*n);
      const half = z * Math.sqrt((p*(1-p))/n + (z*z)/(4*n*n));
      return [Math.max(0, (center - half)/den), Math.min(1, (center + half)/den)];
    }

    // Judge accuracy map (bot_id -> { good, total, acc }) - legacy fallback
    let judgeMap = new Map();

    function judgeStatsFor(botId, row){
      const stats = { good: undefined, total: undefined, acc: undefined };
      if (row) {
        const goodNum = Number(row.good);
        if (!Number.isNaN(goodNum)) stats.good = goodNum;
        const totalNum = Number(row.total);
        if (!Number.isNaN(totalNum)) stats.total = totalNum;
        const accNum = Number(row.acc);
        if (!Number.isNaN(accNum)) stats.acc = accNum;
      }
      const live = judgeMap.get(botId);
      if (live) {
        const goodNum = Number(live.good);
        if (!Number.isNaN(goodNum)) stats.good = goodNum;
        const totalNum = Number(live.total);
        if (!Number.isNaN(totalNum)) stats.total = totalNum;
        const accNum = Number(live.acc);
        if (!Number.isNaN(accNum)) stats.acc = accNum;
      }
      const total = Number(stats.total);
      if (!Number.isFinite(total) || total <= 0) {
        return { hasData: false, display: '—', ratio: 0, good: Number(stats.good || 0), total: 0 };
      }
      const good = Number(stats.good || 0);
      const ratioRaw = Number.isFinite(stats.acc) ? stats.acc : (total > 0 ? good / total : 0);
      const ratio = Math.max(0, Math.min(1, ratioRaw));
      const pct = Math.round(ratio * 100);
      return { hasData: true, display: `${pct}% (${good}/${total})`, ratio, good, total };
    }

    function companyIconMarkup(company, model){
      const meta = resolveCompanyMeta(company, model);
      const icon = COMPANY_ICON_DATA[meta.slug];
      if (icon) {
        return `<img class="org-icon" src="${icon.path}" alt="${icon.alt}"/>`;
      }
      return '<span class="org-icon org-icon--dot" aria-hidden="true"></span>';
    }

    function orgCell(company, model){
      const label = escapeHtml(canonicalCompany(company, model));
      return `<span class="lb-org"><span class="txt">${label}</span></span>`;
    }

    function modelIcon(company, model){
      return companyIconMarkup(company, model);
    }

function rowHTML(i, r){
      const full  = trim1(r.model||'');
      const short = trimModelName(full);
      const title = full.replace(/"/g,'&quot;');
      const wins  = Number(r.career_wins||0);
      const hands = Number(r.career_hands||0);
      const ci    = wilson(wins, hands);
      const ciTxt = hands ? ` (${Math.round(ci[0]*100)}-${Math.round(ci[1]*100)}%)` : '';
      const judge = judgeStatsFor(r.bot_id, r);
      return `<tr class="lb-row" data-href="/web/bot.html?id=${r.bot_id}">
        <td class="num">${i+1}</td>
        <td>
          <div class="lb-model">
            ${modelIcon(r.company, r.model)}
            <a href="/web/bot.html?id=${r.bot_id}" class="name" title="${title}">${short}</a>
          </div>
        </td>
        <td class="num">${Number(r.elo||0).toFixed(1)}</td>
        <td>${orgCell(r.company, r.model)}</td>
        <td class="num">${fmt(hands)}</td>
        <td class="num">${Math.max(0,Math.min(100, Number(r.win_rate_pct||0)))}%<span class="sub">${ciTxt}</span></td>
        <td class="num">${judge.hasData ? judge.display : '—'}</td>
        <td class="num">${fmt(r.net_chips)}</td>
        <td class="sub">${r.updated_at ? dateFmt(r.updated_at) : 'n/a'}</td>
      </tr>`;
    }

    async function getJSON(url, fallback){
      try{
        const r = await fetch(url); if(r.ok) return await r.json();
      }catch(e){}
      if (fallback){
        try{
          const r2 = await fetch(fallback); if(r2.ok) return await r2.json();
        }catch(e){}
      }
      return null;
    }

    async function load(){
      const d = await getJSON('/api/leaderboard', '/web/data/leaderboard.json');
      if (!d) { $('#tbody').innerHTML = `<tr><td colspan="9">No data yet. Run a duel first.</td></tr>`; return; }
      let rows = (d.rows||[]).slice();

      // Load judge accuracy (best-effort)
      try {
        const ja = await getJSON('/api/judge-accuracy', '/web/data/judge-accuracy.json');
        if (ja && ja.rows) {
          judgeMap.clear();
          (ja.rows||[]).forEach(x => judgeMap.set(x.bot_id, x));
        }
      } catch {}

      let sortKey = 'elo';
      let sortDesc = true;

      function setHeaderIndicators(){
        document.querySelectorAll('.lb-table thead th.sortable').forEach(th=>{
          const key = th.getAttribute('data-sort');
          if (key === sortKey) th.setAttribute('data-dir', sortDesc ? 'desc' : 'asc');
          else th.removeAttribute('data-dir');
        });
      }

      function render(){
        const out = rows.slice().sort((a,b)=>{
          const num = (x)=>Number(x||0);
          if (sortKey === 'elo')     return (sortDesc? -1:1) * (num(a.elo) - num(b.elo));
          if (sortKey === 'hands')   return (sortDesc? -1:1) * (num(a.hands||a.career_hands) - num(b.hands||b.career_hands));
          if (sortKey === 'win')     return (sortDesc? -1:1) * (num(a.win_rate_pct) - num(b.win_rate_pct));
          if (sortKey === 'net')     return (sortDesc? -1:1) * (num(a.net_chips) - num(b.net_chips));
          if (sortKey === 'acc') {
            const accA = judgeStatsFor(a.bot_id, a).ratio;
            const accB = judgeStatsFor(b.bot_id, b).ratio;
            return (sortDesc? -1:1) * (accA - accB);
          }
          if (sortKey === 'updated') return (sortDesc? -1:1) * ((new Date(a.updated_at)) - (new Date(b.updated_at)));
          return 0;
        });
        $('#tbody').innerHTML = out.map((r,i)=>rowHTML(i,r)).join('');

        // Append judge accuracy pills next to model name
        try {
          document.querySelectorAll('tr.lb-row').forEach(tr => {
            const href = tr.getAttribute('data-href')||'';
            const idMatch = href.match(/id=(\d+)/);
            if (!idMatch) return;
            const botId = Number(idMatch[1]);
            const row = rows.find(x => Number(x.bot_id) === botId);
            const stats = judgeStatsFor(botId, row);
            if (!stats.hasData) return;
            const host = tr.querySelector('.lb-model');
            if (!host) return;
            const pill = document.createElement('span');
            pill.className = 'pill ghost';
            pill.style.marginLeft = '6px';
            pill.title = `EV judge accuracy (${stats.good}/${stats.total})`;
            pill.textContent = stats.display;
            host.appendChild(pill);
          });
        } catch {}
        setHeaderIndicators();
      }

      async function refreshJudgeAccuracy(){
        try{
        const ja = await getJSON('/api/judge-accuracy', '/web/data/judge-accuracy.json');
          if (!ja || !ja.rows) return;
          judgeMap.clear();
          (ja.rows||[]).forEach(x => judgeMap.set(x.bot_id, x));
          document.querySelectorAll('tr.lb-row').forEach(tr => {
            const href = tr.getAttribute('data-href')||'';
            const idMatch = href.match(/id=(\d+)/);
            if (!idMatch) return;
            const botId = Number(idMatch[1]);
            const row = rows.find(x => Number(x.bot_id) === botId);
            const stats = judgeStatsFor(botId, row);
            const host = tr.querySelector('.lb-model');
            if (host){
              const existing = host.querySelector('.pill.ghost');
              if (stats.hasData) {
                let pill = existing;
                if (!pill){
                  pill = document.createElement('span');
                  pill.className='pill ghost';
                  pill.style.marginLeft='6px';
                  host.appendChild(pill);
                }
                pill.title = `EV judge accuracy (${stats.good}/${stats.total})`;
                pill.textContent = stats.display;
              } else if (existing) {
                existing.remove();
              }
            }
            const tds = tr.querySelectorAll('td');
            if (tds.length >= 7){
              tds[6].textContent = stats.hasData ? stats.display : '—';
            }
          });
        }catch{}
      }

      // header click sorting
      document.querySelectorAll('.lb-table thead th.sortable').forEach(th=>{
        th.addEventListener('click', ()=>{
          const key = th.getAttribute('data-sort');
          if (!key) return;
          if (sortKey === key) { sortDesc = !sortDesc; } else { sortKey = key; sortDesc = true; }
          render();
        });
      });

      render();
      setInterval(refreshJudgeAccuracy, 10000);

      const tb = $('#tbody');
      tb.addEventListener('click', (e)=>{
        if (e.target.closest('a')) return;
        const tr = e.target.closest('tr.lb-row'); if (!tr) return;
        const href = tr.getAttribute('data-href'); if (href) location.href = href;
      });
    }
    addEventListener('DOMContentLoaded', load);
  </script>
</head>
<body>
  <header class="site-header">
    <div class="topnav">
      <a class="brand" href="/web/index.html" aria-label="PokerBench home">
        <span class="brand__mark logo-badge logo-badge--sm">
          <img src="/web/img/pokerBenchlogo.svg" alt="PokerBench logo"/>
        </span>
        <span class="brand__text">PokerBench</span>
      </a>
      <nav>
        <a class="pill" href="/web/leaderboard.html">Leaderboard</a>
        <a class="pill" href="/web/matrix.html">Matrix</a>
        <a class="pill" href="/web/elo.html">Elo</a>
        <a class="pill" href="/web/replay.html">Replay</a>
        <a class="pill" href="/web/history.html">History</a>
        <a class="pill" href="/web/about.html">About</a>
      </nav>
    </div>
  </header>

  <main class="page-content">
    <div class="wrap wrap--wide">
      <div class="card lb-card">
        <div class="lb-card__header">
          <div>
            <h1>Leaderboard</h1>
            <div class="muted">Elo with career hands, win%, and net chips.</div>
          </div>
        </div>
        <div class="lb-card__body">
          <div class="lb-table-wrap">
            <table class="lb-table">
            <colgroup>
              <col style="width:56px" />
              <col style="width:260px" />
              <col style="width:110px" />
              <col style="width:120px" />
              <col style="width:120px" />
              <col style="width:160px" />
              <col style="width:120px" />
              <col style="width:130px" />
              <col style="width:220px" />
            </colgroup>
            <thead>
              <tr>
                <th class="num">#</th>
                <th>Model</th>
                <th class="num sortable" data-sort="elo" title="Sort by Elo">Elo</th>
                <th>Org</th>
                <th class="num sortable" data-sort="hands" title="Sort by Hands">Hands</th>
                <th class="num sortable" data-sort="win" title="Sort by Win %">Win%</th>
                <th class="num sortable" data-sort="acc" title="Sort by Judge Accuracy">Acc</th>
                <th class="num sortable" data-sort="net" title="Sort by Net">Net</th>
                <th class="sortable" data-sort="updated" title="Sort by Updated">Updated</th>
              </tr>
            </thead>
            <tbody id="tbody"><tr><td colspan="9">Loading...</td></tr></tbody>
          </table>
        </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="site-footer__inner">
      <a class="site-footer__brand" href="/web/index.html">
        <span class="logo-badge logo-badge--sm">
          <img src="/web/img/pokerBenchlogo.svg" alt="PokerBench logo"/>
        </span>
        <span>PokerBench</span>
      </a>
      <nav class="site-footer__nav" aria-label="Footer">
        <a href="/web/leaderboard.html">Leaderboard</a>
        <a href="/web/matrix.html">Matrix</a>
        <a href="/web/history.html">History</a>
        <a href="/web/about.html">About</a>
        <a href="https://github.com/jackkayser2005/pokerBench" target="_blank" rel="noopener">GitHub</a>
      </nav>
      <p class="site-footer__copy">© 2025 PokerBench</p>
    </div>
  </footer>
</body>
</html>
